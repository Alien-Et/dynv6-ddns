name: Release Build

on:
  # è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼ˆæ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶ï¼‰
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘æ¡ä»¶ï¼ˆé€šè¿‡GitHub UIï¼‰
  workflow_dispatch:
    inputs:
      target-platforms:
        description: "é€‰æ‹©æ„å»ºå¹³å°ï¼ˆç•™ç©ºåˆ™æ„å»ºå…¨éƒ¨ï¼‰"
        required: false
        default: "all"
        type: choice
        options:
          - "all"
          - "windows"
          - "linux"
          - "macos"
          - "android"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: 
          - { os: windows, arch: 386, ext: .exe, target: windows-32, group: "windows" }
          - { os: windows, arch: amd64, ext: .exe, target: windows-64, group: "windows" }
          - { os: linux, arch: 386, ext: , target: linux-32, group: "linux" }
          - { os: linux, arch: amd64, ext: , target: linux-64, group: "linux" }
          - { os: linux, arch: arm, ext: , target: linux-arm, group: "linux" }
          - { os: linux, arch: arm64, ext: , target: linux-arm64, group: "linux" }
          - { os: darwin, arch: amd64, ext: , target: macos-intel, group: "macos" }
          - { os: darwin, arch: arm64, ext: , target: macos-arm64, group: "macos" }
          - { os: android, arch: arm, ext: , target: android-arm, group: "android" }
          - { os: android, arch: arm64, ext: , target: android-arm64, group: "android" }
      
      # æ ¹æ®æ‰‹åŠ¨è§¦å‘è¾“å…¥è¿‡æ»¤å¹³å°
      include: ${{ fromJson(needs.setup.outputs.selected-platforms) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.21'

      - name: Set up Android NDK
        if: matrix.platform.group == 'android'
        uses: android-actions/setup-android-ndk@v1
        with:
          ndk-version: '25.1.8937393'

      - name: Build binary
        env:
          GOOS: ${{ matrix.platform.os }}
          GOARCH: ${{ matrix.platform.arch }}
          CGO_ENABLED: ${{ matrix.platform.group == 'android' && '0' || '1' }}
          # Android ä¸“ç”¨ç¯å¢ƒå˜é‡
          CC: ${{ matrix.platform.group == 'android' && format('{0}/toolchains/llvm/prebuilt/linux-x86_64/bin/{1}21-clang', env.ANDROID_NDK_HOME, matrix.platform.arch == 'arm' && 'armv7a-linux-androideabi' || 'aarch64-linux-android') || '' }}
          CXX: ${{ matrix.platform.group == 'android' && format('{0}/toolchains/llvm/prebuilt/linux-x86_64/bin/{1}21-clang++', env.ANDROID_NDK_HOME, matrix.platform.arch == 'arm' && 'armv7a-linux-androideabi' || 'aarch64-linux-android') || '' }}
        run: |
          # åˆ›å»ºå¹³å°ä¸“ç”¨ç›®å½•
          mkdir -p release/${{ matrix.platform.target }}
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          output_name="dynv6-ddns${{ matrix.platform.ext }}"
          go build -ldflags="-s -w" -o $output_name .
          
          # å¤åˆ¶é™æ€èµ„æº
          cp -r static release/${{ matrix.platform.target }}/
          
          # ç§»åŠ¨äºŒè¿›åˆ¶æ–‡ä»¶
          mv $output_name release/${{ matrix.platform.target }}/
          
          # åˆ›å»ºå‹ç¼©åŒ…ï¼ˆåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼‰
          cd release
          tar -czf ${{ matrix.platform.target }}-${{ github.ref_name || 'dev' }}.tar.gz ${{ matrix.platform.target }}
          rm -rf ${{ matrix.platform.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: dynv6-ddns-${{ matrix.platform.target }}
          path: release/${{ matrix.platform.target }}-*.tar.gz

  # å‰ç½®å·¥ä½œï¼ˆç”¨äºæ‰‹åŠ¨è§¦å‘æ—¶è¿‡æ»¤å¹³å°ï¼‰
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      selected-platforms: ${{ steps.filter-platforms.outputs.selected-platforms }}
    steps:
      - name: Filter platforms
        id: filter-platforms
        run: |
          # è‡ªåŠ¨è§¦å‘æ—¶ä½¿ç”¨å…¨éƒ¨å¹³å°
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo '::set-output name=selected-platforms::[]'
            exit 0
          fi
          
          # æ‰‹åŠ¨è§¦å‘æ—¶æ ¹æ®é€‰æ‹©è¿‡æ»¤
          case "${{ inputs.target-platforms }}" in
            "windows")
              echo '::set-output name=selected-platforms::[{"os":"windows","arch":"386","ext":".exe","target":"windows-32","group":"windows"},{"os":"windows","arch":"amd64","ext":".exe","target":"windows-64","group":"windows"}]'
              ;;
            "linux")
              echo '::set-output name=selected-platforms::[{"os":"linux","arch":"386","ext":"","target":"linux-32","group":"linux"},{"os":"linux","arch":"amd64","ext":"","target":"linux-64","group":"linux"},{"os":"linux","arch":"arm","ext":"","target":"linux-arm","group":"linux"},{"os":"linux","arch":"arm64","ext":"","target":"linux-arm64","group":"linux"}]'
              ;;
            "macos")
              echo '::set-output name=selected-platforms::[{"os":"darwin","arch":"amd64","ext":"","target":"macos-intel","group":"macos"},{"os":"darwin","arch":"arm64","ext":"","target":"macos-arm64","group":"macos"}]'
              ;;
            "android")
              echo '::set-output name=selected-platforms::[{"os":"android","arch":"arm","ext":"","target":"android-arm","group":"android"},{"os":"android","arch":"arm64","ext":"","target":"android-arm64","group":"android"}]'
              ;;
            *)
              echo '::set-output name=selected-platforms::[]'
              ;;
          esac

  release:
    name: Create Release
    needs: [build]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸš€ Dynv6 DDNS Updater ${{ github.ref_name }}
            
            ### æ”¯æŒå¹³å°
            | å¹³å° | æ¶æ„ |
            |------|------|
            | Windows | 32-bit, 64-bit |
            | Linux | 32-bit, 64-bit, ARM, ARM64 |
            | macOS | Intel, Apple Silicon |
            | Android | ARM, ARM64 |
            
            ### ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
            2. è§£å‹åè¿è¡Œ `dynv6-ddns` (Windows ä¸º `dynv6-ddns.exe`)
            3. è®¿é—® `http://localhost:8080` è¿›è¡Œé…ç½®
          files: |
            artifacts/**/*.tar.gz
