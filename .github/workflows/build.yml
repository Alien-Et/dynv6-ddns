name: Build Cross-Platform Binaries

# 触发条件：推送到 main 分支、创建 v* 标签或提交拉取请求
on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:

jobs:
  build:
    name: 构建 ${{ matrix.target.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux 64-bit
          - os: ubuntu-latest
            target:
              name: linux-amd64
              goos: linux
              goarch: amd64
              ext: ""
          # Linux 32-bit
          - os: ubuntu-latest
            target:
              name: linux-i386
              goos: linux
              goarch: 386
              ext: ""
          # Windows 64-bit
          - os: windows-latest
            target:
              name: windows-amd64
              goos: windows
              goarch: amd64
              ext: ".exe"
          # Windows 32-bit
          - os: windows-latest
            target:
              name: windows-i386
              goos: windows
              goarch: 386
              ext: ".exe"
          # macOS 64-bit
          - os: macos-latest
            target:
              name: macos-amd64
              goos: darwin
              goarch: amd64
              ext: ""
          # macOS ARM64 (M1/M2)
          - os: macos-latest
            target:
              name: macos-arm64
              goos: darwin
              goarch: arm64
              ext: ""
          # Android ARM 32-bit
          - os: ubuntu-latest
            target:
              name: android-arm
              goos: android
              goarch: arm
              ext: ""
              cross_target: arm-linux-androideabi
          # Android ARM 64-bit
          - os: ubuntu-latest
            target:
              name: android-arm64
              goos: android
              goarch: arm64
              ext: ""
              cross_target: aarch64-linux-android

    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 设置 Go 环境
      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.21'  # 使用 >=1.21 以支持最新补丁版本

      # 运行测试
      - name: 运行测试
        run: go test ./...

      # 为 Android 构建设置 Rust
      - name: 设置 Rust 环境
        if: contains(matrix.target.goos, 'android')
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          default: true

      # 为 Android 构建安装 NDK
      - name: 设置 Android NDK
        if: contains(matrix.target.goos, 'android')
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
        id: setup-ndk

      # 安装 cross 工具用于 Android 构建
      - name: 安装 Cross 工具
        if: contains(matrix.target.goos, 'android')
        run: |
          cargo install cross --locked

      # 在 Windows 上安装 7z
      - name: 在 Windows 上安装 7z
        if: contains(matrix.target.goos, 'windows')
        run: choco install 7zip
        shell: powershell

      # 构建二进制文件
      - name: 构建二进制文件
        env:
          GOOS: ${{ matrix.target.goos }}
          GOARCH: ${{ matrix.target.goarch }}
          CGO_ENABLED: 0
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          if [ "${{ matrix.target.goos }}" = "android" ]; then
            cross build --release --target ${{ matrix.target.cross_target }}
          else
            go build -o dynv6${{ matrix.target.ext }} -ldflags "-s -w" .
          fi

      # 打包二进制文件和静态文件
      - name: 打包二进制文件
        run: |
          BINARY_NAME="dynv6-${{ matrix.target.name }}${{ matrix.target.ext }}"
          mv dynv6${{ matrix.target.ext }} $BINARY_NAME
          if [ "${{ matrix.target.goos }}" = "windows" ]; then
            7z a $BINARY_NAME.zip $BINARY_NAME static/
            echo "ASSET=$BINARY_NAME.zip" >> $GITHUB_ENV
          else
            tar -czf $BINARY_NAME.tar.gz $BINARY_NAME static/
            echo "ASSET=$BINARY_NAME.tar.gz" >> $GITHUB_ENV
          fi

      # 上传构建产物
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dynv6-${{ matrix.target.name }}
          path: ${{ env.ASSET }}

  release:
    name: 创建发布
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 下载所有构建产物
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 创建 GitHub Release 并上传产物
      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/dynv6-*/dynv6-*.tar.gz
            artifacts/dynv6-*/dynv6-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}